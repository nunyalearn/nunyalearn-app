generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     Int                     @id @default(autoincrement())
  full_name              String
  email                  String                  @unique
  password_hash          String
  join_date              DateTime                @default(now())
  is_premium             Boolean                 @default(false)
  xp_total               Int                     @default(0)
  level                  Int                     @default(1)
  streak_days            Int                     @default(0)
  role                   Role                    @default(USER)
  is_active              Boolean                 @default(true)
  adminAuditLogs         AdminAuditLog[]         @relation("AdminAuditTrail")
  attempts               Attempt[]
  notifications          Notification[]          @relation("NotificationCreator")
  passwordResets         PasswordReset[]
  payments               Payment[]
  progress               Progress[]
  issuedRewardGrants     RewardGrant[]           @relation("RewardIssuer")
  rewardGrants           RewardGrant[]           @relation("RewardRecipient")
  subscriptions          Subscription[]
  supportResponses       SupportResponse[]       @relation("SupportResponseAuthor")
  assignedTickets        SupportTicket[]         @relation("TicketAssignee")
  reportedTickets        SupportTicket[]         @relation("TicketReporter")
  userAchievements       UserAchievement[]
  userChallenges         UserChallenge[]
  tokens                 UserToken[]
  xpHistory              XpHistory[]
  createdQuestions       QuestionBank[]
  quizAttemptsV2         QuizAttemptV2[]
  practiceTestAttemptsV2 PracticeTestAttemptV2[]
  questionAttemptsV2     QuestionAttemptV2[]
  topicMastery           TopicMastery[]
  xpTransactions         XpTransaction[]
}

model Subject {
  id                  Int                  @id @default(autoincrement())
  subject_name        String
  grade_level         String
  description         String?
  created_at          DateTime             @default(now())
  grade_level_id      Int?
  is_active           Boolean              @default(true)
  updated_at          DateTime             @default(now()) @updatedAt
  legacyPracticeTests LegacyPracticeTest[]
  practiceTests       PracticeTest[]
  GradeLevel          GradeLevel?          @relation(fields: [grade_level_id], references: [id])
  topics              Topic[]

  @@unique([grade_level_id, subject_name])
}

model Topic {
  id            Int            @id @default(autoincrement())
  subject_id    Int
  topic_name    String
  difficulty    String         @default("med")
  created_at    DateTime       @default(now())
  is_active     Boolean        @default(true)
  updated_at    DateTime       @default(now()) @updatedAt
  flashcards    Flashcard[]
  progress      Progress[]
  legacyQuizzes LegacyQuiz[]
  quizzes       Quiz[]
  questions     QuestionBank[]
  mastery       TopicMastery[]
  Subject       Subject        @relation(fields: [subject_id], references: [id])

  @@unique([subject_id, topic_name])
}

model Flashcard {
  id         Int      @id @default(autoincrement())
  topic_id   Int
  front_text String
  back_text  String
  image_url  String?
  language   String   @default("en")
  is_premium Boolean  @default(false)
  created_at DateTime @default(now())
  Topic      Topic    @relation(fields: [topic_id], references: [id])
}

model LegacyQuiz {
  id                  Int                      @id @default(autoincrement())
  topic_id            Int
  question_text       String
  option_a            String
  option_b            String
  option_c            String
  option_d            String
  correct_option      String
  difficulty          String                   @default("med")
  is_premium          Boolean                  @default(false)
  created_at          DateTime                 @default(now())
  competency          String?
  question_type       String?
  xp_reward           Int                      @default(0)
  attempts            Attempt[]
  legacyPracticeTests LegacyPracticeTestQuiz[]
  Topic               Topic                    @relation(fields: [topic_id], references: [id])

  @@map("Quiz")
}

model Quiz {
  id          Int             @id @default(autoincrement())
  topicId     Int
  title       String
  description String?
  difficulty  Difficulty      @default(MEDIUM)
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  Topic       Topic           @relation(fields: [topicId], references: [id])
  questions   QuizQuestion[]
  attemptsV2  QuizAttemptV2[]

  @@map("TopicQuiz")
}

model QuizQuestion {
  id         Int          @id @default(autoincrement())
  quizId     Int
  questionId Int
  orderIndex Int          @default(0)
  createdAt  DateTime     @default(now())
  Quiz       Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  Question   QuestionBank @relation(fields: [questionId], references: [id])

  @@unique([quizId, questionId])
  @@index([questionId])
}

model QuestionBank {
  id                    Int                    @id @default(autoincrement())
  questionText          String
  questionType          QuestionType           @default(MULTIPLE_CHOICE)
  options               Json?
  correctOption         String?
  correctAnswers        Json?
  topicId               Int
  difficulty            Difficulty             @default(EASY)
  language              String                 @default("EN")
  imageUrl              String?
  explanation           String?
  isActive              Boolean                @default(true)
  status                QuestionStatus         @default(ACTIVE)
  createdById           Int?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  Topic                 Topic                  @relation(fields: [topicId], references: [id])
  CreatedBy             User?                  @relation(fields: [createdById], references: [id])
  quizQuestions         QuizQuestion[]
  practiceTestQuestions PracticeTestQuestion[]
  questionAttemptsV2    QuestionAttemptV2[]
}

model Attempt {
  id              Int        @id @default(autoincrement())
  user_id         Int
  quiz_id         Int
  selected_option String
  is_correct      Boolean
  score           Int
  attempt_date    DateTime   @default(now())
  LegacyQuiz      LegacyQuiz @relation(fields: [quiz_id], references: [id])
  User            User       @relation(fields: [user_id], references: [id])
}

model Progress {
  id                 Int      @id @default(autoincrement())
  user_id            Int
  topic_id           Int
  completion_percent Float    @default(0)
  xp_earned          Int      @default(0)
  last_updated       DateTime @default(now())
  Topic              Topic    @relation(fields: [topic_id], references: [id])
  User               User     @relation(fields: [user_id], references: [id])

  @@unique([user_id, topic_id])
}

model Badge {
  id          Int     @id @default(autoincrement())
  name        String
  xp_required Int
  icon_url    String?
}

model Achievement {
  id           Int               @id @default(autoincrement())
  name         String            @unique
  description  String?
  xp_reward    Int               @default(0)
  criteria     String?
  icon_url     String?
  created_at   DateTime          @default(now())
  userProgress UserAchievement[]
}

model UserAchievement {
  user_id        Int
  achievement_id Int
  earned_at      DateTime    @default(now())
  Achievement    Achievement @relation(fields: [achievement_id], references: [id], onDelete: Cascade)
  User           User        @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@id([user_id, achievement_id])
}

model Challenge {
  id           Int             @id @default(autoincrement())
  title        String
  description  String?
  type         ChallengeType
  xp_reward    Int
  start_date   DateTime
  end_date     DateTime
  icon_url     String?
  created_at   DateTime        @default(now())
  participants UserChallenge[]
}

model UserChallenge {
  user_id      Int
  challenge_id Int
  status       ChallengeStatus @default(joined)
  progress     Float?          @default(0)
  joined_at    DateTime        @default(now())
  completed_at DateTime?
  Challenge    Challenge       @relation(fields: [challenge_id], references: [id], onDelete: Cascade)
  User         User            @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@id([user_id, challenge_id])
}

model XpHistory {
  id         Int      @id @default(autoincrement())
  user_id    Int
  xp_change  Int
  reason     String?
  created_at DateTime @default(now())
  User       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model LegacyPracticeTest {
  id               Int                      @id @default(autoincrement())
  title            String
  description      String?
  subject_id       Int?
  difficulty       String                   @default("med")
  xp_reward        Int                      @default(0)
  duration_minutes Int?
  is_active        Boolean                  @default(true)
  created_at       DateTime                 @default(now())
  updated_at       DateTime                 @updatedAt
  Subject          Subject?                 @relation(fields: [subject_id], references: [id])
  quizzes          LegacyPracticeTestQuiz[]

  @@map("LegacyPracticeTest")
}

model LegacyPracticeTestQuiz {
  practice_test_id Int
  quiz_id          Int
  order_index      Int?
  PracticeTest     LegacyPracticeTest @relation(fields: [practice_test_id], references: [id], onDelete: Cascade)
  LegacyQuiz       LegacyQuiz         @relation(fields: [quiz_id], references: [id], onDelete: Cascade)

  @@id([practice_test_id, quiz_id])
  @@map("LegacyPracticeTestQuiz")
}

model PracticeTest {
  id              Int                     @id @default(autoincrement())
  title           String
  description     String?
  subjectId       Int?
  gradeLevelId    Int?
  xpReward        Int                     @default(0)
  questionCount   Int
  durationMinutes Int?
  difficultyMix   Json?
  topicFilters    Json?
  isActive        Boolean                 @default(true)
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  Subject         Subject?                @relation(fields: [subjectId], references: [id])
  GradeLevel      GradeLevel?             @relation(fields: [gradeLevelId], references: [id])
  questions       PracticeTestQuestion[]
  attemptsV2      PracticeTestAttemptV2[]
}

model PracticeTestQuestion {
  id             Int          @id @default(autoincrement())
  practiceTestId Int
  questionId     Int
  orderIndex     Int          @default(0)
  createdAt      DateTime     @default(now())
  PracticeTest   PracticeTest @relation(fields: [practiceTestId], references: [id], onDelete: Cascade)
  Question       QuestionBank @relation(fields: [questionId], references: [id])

  @@unique([practiceTestId, questionId])
  @@index([questionId])
}

model Notification {
  id           Int                 @id @default(autoincrement())
  title        String
  message      String
  status       NotificationStatus  @default(draft)
  channel      NotificationChannel @default(app)
  audience     String?
  scheduled_at DateTime?
  published_at DateTime?
  created_at   DateTime            @default(now())
  updated_at   DateTime            @updatedAt
  created_by   Int?
  Creator      User?               @relation("NotificationCreator", fields: [created_by], references: [id])
}

model SupportTicket {
  id          Int               @id @default(autoincrement())
  subject     String
  message     String?
  status      TicketStatus      @default(open)
  priority    TicketPriority    @default(medium)
  user_id     Int?
  user_email  String
  assigned_to Int?
  created_at  DateTime          @default(now())
  updated_at  DateTime          @updatedAt
  closed_at   DateTime?
  responses   SupportResponse[]
  Assignee    User?             @relation("TicketAssignee", fields: [assigned_to], references: [id])
  Reporter    User?             @relation("TicketReporter", fields: [user_id], references: [id])
}

model SupportResponse {
  id         Int           @id @default(autoincrement())
  ticket_id  Int
  author_id  Int?
  message    String
  created_at DateTime      @default(now())
  Author     User?         @relation("SupportResponseAuthor", fields: [author_id], references: [id])
  Ticket     SupportTicket @relation(fields: [ticket_id], references: [id], onDelete: Cascade)
}

model Payment {
  id         Int           @id @default(autoincrement())
  user_id    Int?
  user_email String
  amount     Int
  currency   String        @default("USD")
  status     PaymentStatus @default(pending)
  method     String?
  reference  String?       @unique
  created_at DateTime      @default(now())
  updated_at DateTime      @updatedAt
  User       User?         @relation(fields: [user_id], references: [id])
}

model Subscription {
  id         Int                @id @default(autoincrement())
  user_id    Int?
  user_email String
  plan       String
  status     SubscriptionStatus @default(active)
  renews_at  DateTime?
  expires_at DateTime?
  created_at DateTime           @default(now())
  updated_at DateTime           @updatedAt
  User       User?              @relation(fields: [user_id], references: [id])
}

model Reward {
  id          Int           @id @default(autoincrement())
  title       String
  description String?
  xp_value    Int           @default(0)
  is_active   Boolean       @default(true)
  created_at  DateTime      @default(now())
  updated_at  DateTime      @updatedAt
  grants      RewardGrant[]
}

model RewardGrant {
  id         Int      @id @default(autoincrement())
  reward_id  Int?
  user_id    Int
  granted_by Int?
  xp_awarded Int      @default(0)
  reason     String?
  created_at DateTime @default(now())
  Admin      User?    @relation("RewardIssuer", fields: [granted_by], references: [id])
  Reward     Reward?  @relation(fields: [reward_id], references: [id])
  Recipient  User     @relation("RewardRecipient", fields: [user_id], references: [id])
}

model PlatformSetting {
  id                    Int      @id @default(1)
  default_role          Role     @default(USER)
  onboarding_message    String?
  notifications_enabled Boolean  @default(true)
  xp_multiplier         Float    @default(1)
  updated_at            DateTime @updatedAt
}

model GradeLevel {
  id            Int            @id @default(autoincrement())
  name          String         @unique
  description   String?
  order_index   Int?
  is_active     Boolean        @default(true)
  created_at    DateTime       @default(now())
  updated_at    DateTime       @updatedAt
  subjects      Subject[]
  practiceTests PracticeTest[]
}

model UserToken {
  id         Int      @id @default(autoincrement())
  user_id    Int
  token      String   @unique
  expires_at DateTime
  created_at DateTime @default(now())
  User       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model PasswordReset {
  id         Int      @id @default(autoincrement())
  user_id    Int
  token      String   @unique
  expires_at DateTime
  used       Boolean  @default(false)
  created_at DateTime @default(now())
  User       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model AdminAuditLog {
  id         Int      @id @default(autoincrement())
  admin_id   Int?
  entity     String
  action     String
  entity_id  Int?
  details    String?
  created_at DateTime @default(now())
  Admin      User?    @relation("AdminAuditTrail", fields: [admin_id], references: [id])
}

model QuizAttemptV2 {
  id               Int                 @id @default(autoincrement())
  quizId           Int
  userId           Int
  status           String              @default("in_progress")
  score            Int?
  totalQuestions   Int?
  correctCount     Int?
  incorrectCount   Int?
  xpAwarded        Int                 @default(0)
  durationSeconds  Int?
  metadata         Json?
  startedAt        DateTime            @default(now())
  completedAt      DateTime?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  Quiz             Quiz                @relation(fields: [quizId], references: [id], onDelete: Cascade)
  User             User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  QuestionAttempts QuestionAttemptV2[]

  @@index([userId])
  @@index([quizId])
}

model PracticeTestAttemptV2 {
  id               Int                 @id @default(autoincrement())
  practiceTestId   Int
  userId           Int
  status           String              @default("in_progress")
  score            Int?
  totalQuestions   Int?
  correctCount     Int?
  incorrectCount   Int?
  xpAwarded        Int                 @default(0)
  durationSeconds  Int?
  metadata         Json?
  startedAt        DateTime            @default(now())
  completedAt      DateTime?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  PracticeTest     PracticeTest        @relation(fields: [practiceTestId], references: [id], onDelete: Cascade)
  User             User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  QuestionAttempts QuestionAttemptV2[]

  @@index([userId])
  @@index([practiceTestId])
}

model QuestionAttemptV2 {
  id                    Int                    @id @default(autoincrement())
  quizAttemptId         Int?
  practiceTestAttemptId Int?
  questionId            Int
  userId                Int
  selectedOption        String?
  selectedOptions       Json?
  isCorrect             Boolean
  score                 Int                    @default(0)
  responseMetadata      Json?
  createdAt             DateTime               @default(now())
  QuizAttempt           QuizAttemptV2?         @relation(fields: [quizAttemptId], references: [id], onDelete: Cascade)
  PracticeTestAttempt   PracticeTestAttemptV2? @relation(fields: [practiceTestAttemptId], references: [id], onDelete: Cascade)
  Question              QuestionBank           @relation(fields: [questionId], references: [id])
  User                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([quizAttemptId])
  @@index([practiceTestAttemptId])
  @@index([userId])
}

model TopicMastery {
  id              Int      @id @default(autoincrement())
  userId          Int
  topicId         Int
  correctAttempts Int      @default(0)
  totalAttempts   Int      @default(0)
  accuracy        Float    @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  User            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  Topic           Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@unique([userId, topicId])
}

model XpTransaction {
  id        Int      @id @default(autoincrement())
  userId    Int
  amount    Int
  reason    String?
  source    String?
  metadata  Json?
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum ChallengeType {
  daily
  weekly
  event
}

enum ChallengeStatus {
  joined
  completed
  expired
}

enum Role {
  USER
  ADMIN
}

enum NotificationStatus {
  draft
  scheduled
  sent
  cancelled
}

enum NotificationChannel {
  app
  email
  push
}

enum TicketStatus {
  open
  pending
  closed
}

enum TicketPriority {
  low
  medium
  high
}

enum PaymentStatus {
  pending
  succeeded
  failed
  refunded
}

enum SubscriptionStatus {
  active
  past_due
  cancelled
  trialing
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  FILL_IN_THE_BLANK
  SHORT_ANSWER
}

enum QuestionStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}
